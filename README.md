# Vidar Workflow

This document outlines the workflow of the Vidar project, detailing each step, the involved folders and files, and the commands to execute them.

## 1. Run Vanir

- **Folder:** `vanir_parser`
- **File:** `vanir_report_parser.py`
- **Description:** Parses a Vanir report into a summarized JSON file.
- **Script Run:** `python vanir_parser/vanir_report_parser.py`
- **Output:** `reports/xiaomi_output.json`

## 2. Download Diff Files

- **Folder:** `download_diff`
- **Files:**
    - `fetch_diff.py`: Contains the logic for downloading diff files from a remote Git repository based on commit hashes.
    - `run_diff_fetcher.py`: Iterates through `reports/parsed_report.json` and processes each patch in the report.
- **Description:** Fetches diff files from a remote Git repository based on commit hashes.
- **Script Run:** `python download_diff/run_diff_fetcher.py`
- **Output:** `fetch_patch_output/diff_output/` (contains the downloaded diff files)

## 3. Patch Adoption

- **Folder:** `patch_adoption`
- **File:** `patch_adopter.py`
- **Description:** Adopts patches using GNU patch and generates a JSON report (`reports/patch_application_report.json`) with rejected files and console output.
- **Script Run:** `python patch_adoption/patch_adopter.py`
- **Testing Single Patch:**
    1. Paste the patch content into `patch_adoption/patch.diff`.
    2. Run `python patch_adoption/patch_runner.py`.
- **Output:** `reports/patch_application_report.json`

## 4. LLM Integration

- **Folder:** `llm_integration`
- **Files:**
    - `gemini_function.py`: Handles AI-based patch porting from upstream to downstream versions using Google's Vertex AI.
    - `patch_llm.py`: Applies an LLM-generated patch file using GNU patch and stores the console output.
- **Description:**  This section covers the integration with Large Language Models (LLMs), specifically using Gemini for patch porting.

### 4.1. Gemini Function (AI-based Patch Porting)

    - **File:** `gemini_function.py`
    - **Description:**  Connects to Vertex AI and handles the patch porting process.
    - **Input:** `llm_integration/failed_patch.json`
    - **Script Run:** `python llm_integration/gemini_function.py`
    - **Output:** A diff file in the root directory (Vidar) named after the commit hash (e.g., `[commit_hash].diff_fixed.diff`).

### 4.2. Patch LLM (Applying LLM-generated Patches)

    - **File:** `patch_llm.py`
    - **Description:** Applies the diff file generated by the LLM using GNU patch.
    - **Script Run:** `python llm_integration/patch_llm.py`