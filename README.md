# Vanir Security Patch Management System

## Overview
Vanir is a security patch management system designed to automate the processing of security vulnerabilities, download relevant patches, and apply them to kernel codebases. It streamlines the patch management workflow using three core components: report parsing, patch fetching, and patch application.

## Running the Pipeline
The entire workflow, from parsing the initial report to applying LLM-corrected patches, can be run with a single script.

**Prerequisites:**
1.  Place your raw Vanir security report at `reports/vanir_output.json`.
2.  Make sure all dependencies from `requirements.txt` are installed (`pip install -r requirements.txt`).
3.  Ensure your `GOOGLE_API_KEYS` and `TARGET_SOURCE_PATH` environment variables are set correctly in your `.env` file.

**Execute the pipeline:**
```bash
python pipeline_runner.py
```
This command will automatically:
1.  **Parse the Vanir Report**: Processes `vanir_output.json`.
2.  **Fetch Patches**: Downloads all required patches from their repositories.
3.  **Apply Original Patches**: Attempts to apply the downloaded patches.
4.  **Prepare for LLM**: Creates a list of all patches that failed to apply.
5.  **Run LLM Correction**: Uses the Gemini LLM to generate corrected patches for the failed ones.
6.  **Apply LLM Patches**: Attempts to apply the new, LLM-generated patches.

The script will print detailed logs for each step.

---

## Core Components
The pipeline is composed of several scripts that `pipeline_runner.py` calls in sequence.

### 1. vanir_report_parser.py
**Description:**  
Processes security vulnerability reports and extracts structured information about required patches.

### 2. patch_fetcher.py
**Description:**  
Downloads patch files from code repositories using the structured report generated by the parser.

### 3. patch_adopter.py
**Description:**  
Applies downloaded patches to the kernel source code and generates detailed reports on application outcomes. It is run twice: once for the original patches (`--source Vanir`) and once for the LLM-generated patches (`--source LLM`).

### 4. llm_patch_runner.py
**Description:**  
For patches that failed to apply, this script uses the Gemini LLM to analyze the failure and generate a corrected patch. It features a self-correction mechanism to retry failed generation attempts with more detailed prompts.

---

## Directory Structure

```

vidar/                    # Core script components
├── pipeline_runner.py      # Main pipeline runner
├── vanir_report_parser.py
├── patch_fetcher.py
├── patch_adopter.py
└── llm_patch_runner.py
├── reports/
│   └── vanir_output.json     # Your initial Vanir report goes here
├── fetch_patch_output/
│   └── diff_output/          # Downloaded original patches
├── patch_adoption/
│   └── generated_patches/    # LLM-generated patches
└── .env                      # For your environment variables
```

---

## Environment Variables

- `TARGET_SOURCE_PATH`: Path to the kernel source code (e.g., `/data/androidOS14`)
- `GOOGLE_API_KEYS`: Comma-separated list of your Google Gemini API keys.

---

## Dependencies

- Python 3.8+
- `requests`
- `python-dotenv`
- `google-generativeai`
- `unidiff`
- GNU `patch` utility (`gpatch` on macOS)
- `git` command-line tool

Install Python dependencies with:
```bash
pip install -r eugene-only/playground1/vidar/requirements.txt
```

---

## Output Files

- `reports/parsed_report.json`: Structured Vanir report data.
- `reports/patch_application_report.json`: Results of applying original `Vanir` patches.
- `reports/1_llm_output.json`: Detailed log and results from the LLM patch generation step.
- `fetch_patch_output/diff_output/*.diff`: Original downloaded patches.
- `patch_adoption/generated_patches/*.diff`: LLM-generated patches.

---

## Troubleshooting

1.  **Pipeline Fails**: The `pipeline_runner.py` script will stop if any step fails. Check the error message in the console to see which script failed and why.
2.  **File Not Found**: Ensure your initial `vanir_output.json` is in the correct location.
3.  **Patch/LLM Failures**: Examine the various JSON reports and `.rej` files generated during the run to diagnose specific patch or LLM issues.
