{
  "cve_id": "CVE-2025-21640",
  "upstream_commit": "92cf7a51bdae24a32c592adcdd59a773ae149289",
  "upstream_patch_content": "From ea62dd1383913b5999f3d16ae99d411f41b528d4 Mon Sep 17 00:00:00 2001\nFrom: \"Matthieu Baerts (NGI0)\" <matttbe@kernel.org>\nDate: Wed, 8 Jan 2025 16:34:32 +0100\nSubject: [PATCH] sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n\nAs mentioned in a previous commit of this series, using the 'net'\nstructure via 'current' is not recommended for different reasons:\n\n- Inconsistency: getting info from the reader's/writer's netns vs only\n  from the opener's netns.\n\n- current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n  (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n  syzbot [1] using acct(2).\n\nThe 'net' structure can be obtained from the table->data using\ncontainer_of().\n\nNote that table->data could also be used directly, as this is the only\nmember needed from the 'net' structure, but that would increase the size\nof this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\nused.\n\nFixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\nCc: stable@vger.kernel.org\nLink: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\nSuggested-by: Al Viro <viro@zeniv.linux.org.uk>\nSigned-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nLink: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\nSigned-off-by: Jakub Kicinski <kuba@kernel.org>\n---\n net/sctp/sysctl.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex e5a5af343c4c..9848d19630a4 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -387,7 +387,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(const struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n-- \n2.39.5 (Apple Git-154)\n\n",
  "successes": [
    {
      "downstream_version": "c0dde4a52b8438e5266027e76dc9cbbe806d301b",
      "downstream_patch": "3cd0659deb9c03535fd61839e91d4d4d3e51ac71",
      "commit_date": "2025-01-17 13:34:41 +0100",
      "result": "success",
      "downstream_patch_content": "commit 3cd0659deb9c03535fd61839e91d4d4d3e51ac71\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Wed Jan 8 16:34:32 2025 +0100\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex 43ebf090029d..01fe23faf20d 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -380,7 +380,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    },
    {
      "downstream_version": "c0e394fd6b887e84da17e38aaa6c1c104f9c86c2",
      "downstream_patch": "ad673e514b2793b8d5902f6ba6ab7e890dea23d5",
      "commit_date": "2025-01-17 13:36:17 +0100",
      "result": "success",
      "downstream_patch_content": "commit ad673e514b2793b8d5902f6ba6ab7e890dea23d5\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Wed Jan 8 16:34:32 2025 +0100\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex f65d6f92afcb..680ee80055f7 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -391,7 +391,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    },
    {
      "downstream_version": "4c74fbdc5ab95b13945be01e6065940b68222db7",
      "downstream_patch": "f0bb3935470684306e4e04793a20ac4c4b08de0b",
      "commit_date": "2025-01-17 13:40:47 +0100",
      "result": "success",
      "downstream_patch_content": "commit f0bb3935470684306e4e04793a20ac4c4b08de0b\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Wed Jan 8 16:34:32 2025 +0100\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex e5a5af343c4c..9848d19630a4 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -387,7 +387,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(const struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    },
    {
      "downstream_version": "e52a55ec2d1f7816a466a0b3e7bbdc7e473cb815",
      "downstream_patch": "86ddf8118123cb58a0fb8724cad6979c4069065b",
      "commit_date": "2025-01-23 17:15:51 +0100",
      "result": "success",
      "downstream_patch_content": "commit 86ddf8118123cb58a0fb8724cad6979c4069065b\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Wed Jan 8 16:34:32 2025 +0100\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex 43ebf090029d..01fe23faf20d 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -380,7 +380,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    },
    {
      "downstream_version": "2c1a42fbd98e882df4ef4b4c630563cd6160891e",
      "downstream_patch": "03ca51faba2b017bf6c90e139434c4117d0afcdc",
      "commit_date": "2025-02-01 18:22:20 +0100",
      "result": "success",
      "downstream_patch_content": "commit 03ca51faba2b017bf6c90e139434c4117d0afcdc\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Wed Jan 8 16:34:32 2025 +0100\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex e4af050aec1b..a2113f4c5415 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -350,7 +350,8 @@ static struct ctl_table sctp_net_table[] = {\n static int proc_sctp_do_hmac_alg(struct ctl_table *ctl, int write,\n \t\t\t\t void *buffer, size_t *lenp, loff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    },
    {
      "downstream_version": "19573dcddb8819fd68d6cd1f916c1c99c3fa4ff4",
      "downstream_patch": "5599b212d2f4466e1832a94e9932684aaa364587",
      "commit_date": "2025-04-10 14:29:35 +0200",
      "result": "success",
      "downstream_patch_content": "commit 5599b212d2f4466e1832a94e9932684aaa364587\nAuthor: Matthieu Baerts (NGI0) <matttbe@kernel.org>\nDate:   Tue Mar 11 15:54:26 2025 -0300\n\n    sctp: sysctl: cookie_hmac_alg: avoid using current->nsproxy\n    \n    commit ea62dd1383913b5999f3d16ae99d411f41b528d4 upstream.\n    \n    As mentioned in a previous commit of this series, using the 'net'\n    structure via 'current' is not recommended for different reasons:\n    \n    - Inconsistency: getting info from the reader's/writer's netns vs only\n      from the opener's netns.\n    \n    - current->nsproxy can be NULL in some cases, resulting in an 'Oops'\n      (null-ptr-deref), e.g. when the current task is exiting, as spotted by\n      syzbot [1] using acct(2).\n    \n    The 'net' structure can be obtained from the table->data using\n    container_of().\n    \n    Note that table->data could also be used directly, as this is the only\n    member needed from the 'net' structure, but that would increase the size\n    of this fix, to use '*data' everywhere 'net->sctp.sctp_hmac_alg' is\n    used.\n    \n    Fixes: 3c68198e7511 (\"sctp: Make hmac algorithm selection for cookie generation dynamic\")\n    Cc: stable@vger.kernel.org\n    Link: https://lore.kernel.org/67769ecb.050a0220.3a8527.003f.GAE@google.com [1]\n    Suggested-by: Al Viro <viro@zeniv.linux.org.uk>\n    Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>\n    Link: https://patch.msgid.link/20250108-net-sysctl-current-nsproxy-v1-4-5df34b2083e8@kernel.org\n    Signed-off-by: Jakub Kicinski <kuba@kernel.org>\n    Signed-off-by: Magali Lemes <magali.lemes@canonical.com>\n    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\n\ndiff --git a/net/sctp/sysctl.c b/net/sctp/sysctl.c\nindex 4ecd3857204d..4116b3cd83c2 100644\n--- a/net/sctp/sysctl.c\n+++ b/net/sctp/sysctl.c\n@@ -326,7 +326,8 @@ static int proc_sctp_do_hmac_alg(struct ctl_table *ctl, int write,\n \t\t\t\tvoid __user *buffer, size_t *lenp,\n \t\t\t\tloff_t *ppos)\n {\n-\tstruct net *net = current->nsproxy->net_ns;\n+\tstruct net *net = container_of(ctl->data, struct net,\n+\t\t\t\t       sctp.sctp_hmac_alg);\n \tstruct ctl_table tbl;\n \tbool changed = false;\n \tchar *none = \"none\";\n"
    }
  ],
  "failures": []
}